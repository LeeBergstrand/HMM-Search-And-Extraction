Query for the relative positions of multiple Hidden Markov model hits across multiple genomes in HMMER-DB.
==========================================================================================================
```{r message = FALSE}
# Imports:
library(ggplot2)
library(RSQLite)
```

#### We can query the HMMER-DB database using a SQL query within R. Our first step is to setup a database connection:
```{r}
# Setting up database connection:
sqlite = dbDriver("SQLite")
HMMDB  = dbConnect(sqlite, "/Users/lee/Data/SteriodHMMs/HMMDBV2.sqlite") # Location of HMMER-DB Sqlite database.
```
#### The code below queries the database and loads the results of the query into a R dataframe (Note: This is a rather complex query with multiple filters). 
```{r}
# Executes SQL query and loads results directly into a dataframe. 
data = dbGetQuery(HMMDB, "/* SQL Outer Query: Wrapper for subquery one that calculates relative protein center from subquery one's relative protein start and stop.*/
                          SELECT
                            subQuery.HMM_Family,
                          	subQuery.Organism_Description,
                          	((subQuery.Protein_Relative_Start + subQuery.Protein_Relative_End) / 2) AS Protein_Relative_Center
                          FROM
                          	(
                              /* SQL Inner Query 1:  For each HMM_Hit, selects the HMM Family name and Organism with the hit and calculates the relative start and stop postions
                                                     of the hit's target protein. Does not select hits for FAD, EchA, hsd4A and Cyp series. The HMM coverage has to be greater
                                                     the 80% or the hit is filtered out. */
                          		SELECT DISTINCT
                          			HMM_Data.HMM_Family,
                          			Organisms.Organism_Description,
                          			(CAST(Proteins.'End' AS float)/CAST(Organisms.Sequence_Length AS float) * 100) as Protein_Relative_End,
                          			(CAST(Proteins.Start AS float)/CAST(Organisms.Sequence_Length AS float) * 100) as Protein_Relative_Start	
                          		FROM
                          			HMM_Data,
                          			HMM_Hits,
                          			Organisms,
                          			Proteins
                          		WHERE
                          			HMM_Data.HMM_Model = HMM_Hits.HMM_Model
                          		AND HMM_Hits.Protein_Accession = Proteins.Protein_Accession
                          		AND Proteins.Organism_Accession = Organisms.Organism_Accession
                          		AND Organisms.Organism_Accession IN (
                          			
                                    /* SQL Inner Query 2: Selects organisms with an completeness (number of HMM families with hits) greater than 60% from organisms with hits for HsaC and KshA*/
                                    SELECT
                          				Organisms.Organism_Accession
                          			FROM
                          				HMM_Data,
                          				HMM_Hits,
                          				Organisms,
                          				Proteins
                          			WHERE
                          				HMM_Data.HMM_Model = HMM_Hits.HMM_Model
                          			AND HMM_Hits.Protein_Accession = Proteins.Protein_Accession
                          			AND Proteins.Organism_Accession = Organisms.Organism_Accession
                          			AND Organisms.Organism_Accession IN (
                          				  
                                        /* SQL Inner Query 3: Selects organisms with hits for HsaC from organism with hits for KshA */
                                        SELECT DISTINCT
                          					Organisms.Organism_Accession
                          				FROM
                          					HMM_Data,
                          					HMM_Hits,
                          					Organisms,
                          					Proteins
                          				WHERE
                          					HMM_Data.HMM_Model = HMM_Hits.HMM_Model
                          				AND HMM_Hits.Protein_Accession = Proteins.Protein_Accession
                          				AND Organisms.Organism_Accession = Proteins.Organism_Accession
                          				AND HMM_Data.HMM_Family = 'hsaC' /* Selects organisms with a hit for HsaC*/
                          				AND Organisms.Organism_Accession IN (
                  
                            				/* SQL Inner Query 4: Selects organisms with hits for KshA */
                                            SELECT DISTINCT 
                          						Organisms.Organism_Accession
                          					FROM
                          						HMM_Data,
                          						HMM_Hits,
                          						Organisms,
                          						Proteins
                          					WHERE
                          						HMM_Data.HMM_Model = HMM_Hits.HMM_Model
                          					AND HMM_Hits.Protein_Accession = Proteins.Protein_Accession
                          					AND Organisms.Organism_Accession = Proteins.Organism_Accession
                          					AND HMM_Data.HMM_Family IN ('KshA') /* Selects organisms with a hit for KshA*/
                          				)
                          			)
                          			GROUP BY
                          				Organisms.Organism_Accession
                          			HAVING
                          				count(DISTINCT HMM_Data.HMM_Family) >= 13.8 /* Filters out organisms with an completeness (number of HMM families with hits) less than 60%*/
                          			ORDER BY
                          				count(DISTINCT HMM_Data.HMM_Family) ASC
                          		)
                          		AND HMM_Data.HMM_Family NOT LIKE '%FAD%' /* Filters out FADs */
                          		AND HMM_Data.HMM_Family NOT LIKE '%EchA%' /* Filters out EchAs */
                          		AND HMM_Data.HMM_Family NOT LIKE '%hsd4A%' /* Filters out hsd4As */
                          		AND HMM_Data.HMM_Family NOT LIKE '%Cyp%' /* Filters out Cyps */
                          		AND HMM_Hits.HMM_Coverage >= 0.8
                          	) AS subQuery")
```

#### We now check if the SQL query is generating the dataframe we want:
```{r}
head(data) # Note: The final column may wrap to the next line.
```

#### We can then use ggplot to plot the relative positions of HMM hits in the genomes of the organisms in the database:
```{r fig.width = 18, fig.height = 18}
plotObj = ggplot(data, aes(x = Protein_Relative_Center, y = Organism_Description, color = factor(HMM_Family)))
plotObj + geom_point(alpha = 3/4) + # Slight alpha so one can visualize overlaping points better.
          ggtitle("Relative positions of proteins with HMM hits for organisms in the database.") + 
          xlab("Protein's relative postion on geneome.") + ylab("Organism") + labs(colour = "Type of HMM hit") 
```

*Please note that most bacterial genomes are circular and the genome may start at an arbitrary point.*

#### We can also use ggplot to plot the relative density of HMM hits in the genomes of the organisms in the database:
```{r fig.width = 18, fig.height = 18}
plotObj = ggplot(data, aes(x = Protein_Relative_Center, y = Organism_Description, fill = 'black'))
plotObj + geom_point(alpha = 1/4) + # Proteins are all the same color and we use alpha to highlight areas with a greater number of hit proteins.
          ggtitle("Relative density of proteins with HMM hits for organisms in the database.") + 
          xlab("Protein's relative postion on geneome.") + ylab("Organism") + theme(legend.position = "none")
```

*Please note that most bacterial genomes are circular and the genome may start at an arbitrary point.*

#### Lets say we want to filter the hits down further to just the key enzymes such as HsaC and KshA. We can use R to make a new filtred dataframe.
```{r}
dataTwo = data[data$HMM_Family %in% c("KshA", "hsaC"), ] # Select rows where the column HMM_Family is equal to KshA or hsaC.
```
#### We now check if the new dataframe is what we want:
```{r}
head(dataTwo) # Note: The final column may wrap to the next line.
```

#### We again use ggplot to plot the relative positions of HMM hits in the genomes of the organisms in the database but now only for HsaC and KshA:
```{r fig.width = 18, fig.height = 18}
plotObj = ggplot(dataTwo, aes(x = Protein_Relative_Center, y = Organism_Description, color = factor(HMM_Family)))
plotObj + geom_point(alpha = 3/4) + # Slight alpha so one can visualize overlaping points better.
          ggtitle("Relative positions of proteins with HMM hits for organisms in the database.") + 
          xlab("Protein's relative postion on geneome.") + ylab("Organism") + labs(colour = "Type of HMM hit") 
```
